name: Multi-Stage Deployment

on:
  push:
    branches: [ main ]

    paths:
      - '**/ci-cd-labs/**'
      - '.github/workflows/advanced-cicd.yml' # Also trigger if the workflow itself changes

  # This allows you to run it manually from the "Actions" tab for testing
  workflow_dispatch:

jobs:
  #Security Scan (Runs in parallel with Build)
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs' # Scan the filesystem
          scan-ref: './03-infrastructure-as-code/code-labs/ci-cd-labs/web-app-project'
          scanners: 'vuln,config,secret' # Adds secret and config scanning
          exit-code: '1' # This forces the job to FAIL if it finds anything
          ignore-unfixed: true
          format: 'table'
          severity: 'CRITICAL,HIGH'

  # STAGE 1: BUILD
  build-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Simulate Build
        run: |
          mkdir build-assets
          echo "Build Version 1.0.23" > build-assets/version.txt
          echo "App files ready." > build-assets/index.html

      - name: Save Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-artifact
          path: build-assets/

  # STAGE 2: STAGING (Depends on Build)
  deploy-staging:
    needs: [build-job, security-scan]
    runs-on: ubuntu-latest
    environment: 
      name: staging
      url: ${{ steps.deployment.outputs.page_url }} # This creates a clickable link in GitHub!
    permissions:
      pages: write      # Required for deploying to Pages
      id-token: write   # Required for security OIDC
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-artifact

      - name: Customize for Staging
        run: sed -i 's/__ENVIRONMENT__/Staging Environment/g' index.html

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.' # Deploys the current folder containing index.html

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # STAGE 3: PRODUCTION (Depends on Staging)
  deploy-production:
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-artifact

      # 1. VERIFY FIRST: Make sure we have the right file before touching production
      - name: Verify Version
        run: |
          VERSION=$(cat version.txt)
          if [ "$VERSION" == "Build Version 1.0.23" ]; then
            echo "SUCCESS: Version matches. Proceeding..."
          else
            echo "ERROR: Version mismatch!"
            exit 1
          fi
      - name: Customize for Production
        run: sed -i 's/__ENVIRONMENT__/Production Environment/g' index.html

      # 2. ATTEMPT DEPLOY
      - name: Deploy to Production
        id: deploy_step
        run: |
          echo "Attempting to deploy Build Version 1.0.23..."
          # Simulate a deployment failure for demonstration
          echo "ERROR: Deployment failed due to network issue."
          # Change 1 to 0 to simulate success
          exit 0 

      # 3. ROLLBACK IF DEPLOY FAILED
      - name: Rollback to Last Stable Version
        if: failure() && steps.deploy_step.outcome == 'failure'
        run: |
          echo "CRITICAL: Production deployment failed!"
          echo "Action: Reverting to previous stable build..."
  notifications:
    # 1. Listen to ALL critical jobs
    needs: [security-scan, build-job, deploy-staging, deploy-production]
    
    # 2. This ensures it runs even if any of the above jobs fail or are skipped
    if: always() 
    
    runs-on: ubuntu-latest
    steps:
      - name: Discord Notification
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          # 3. Use this logic to report the overall pipeline result
          status: ${{ (contains(needs.*.result, 'failure')) && 'failure' || 'success' }}
          title: "Day 23: Pipeline Overall Status"
          description: |
            Security: ${{ needs.security-scan.result }}
            Build: ${{ needs.build-job.result }}
            Staging: ${{ needs.deploy-staging.result }}
            Production: ${{ needs.deploy-production.result }}